<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Berita Acara - Sales Variance</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }

        .container {
            width: 190mm; 
            margin: 0 auto;
            padding: 25px; 
            background-color: white;
            box-sizing: border-box;
        }

        h1.title {
            text-align: center;
            margin-bottom: 25px; 
            font-size: 1.5em;
            text-decoration: underline;
            font-weight: bold;
        }
        
        .data-input {
            margin-bottom: 8px; 
            display: flex;
            align-items: center;
        }
        .data-input label {
            width: 140px;
            font-size: 0.9em;
        }
        .data-input input[type="text"] {
            width: 220px;
            border: none;
            border-bottom: 1px solid #000; 
            padding: 2px 5px;
            outline: none;
        }   

        #kode_toko { font-weight: bold; font-size: 1.1em; width: 80px !important; }

        .keterangan-section {
            margin-top: 15px;
            line-height: 1.4; 
            font-size: 0.95em;
        }
        
        #nilai_sales, #tanggal_kejadian { font-weight: bold; }
        
        #nama_personil, #jabatan, #kode_toko { text-transform: uppercase; }
        
        .keterangan-section input {
            border: none;
            border-bottom: 1px solid #000; 
            padding: 2px 5px;
            font-size: 1em;
        }
        
        textarea {
            width: 100%;
            height: 90px; 
            border: 1px solid #ccc; 
            padding: 10px;
            margin-top: 10px;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        
        .signature-main-grid {
            margin-top: 30px;
            display: grid;
            grid-template-columns: 1.2fr 0.8fr; 
            gap: 30px 20px;
        }

        .sub-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            text-align: center;
        }

        .ttd-single-box {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }

        .ttd-area {
            height: 70px; 
            border: 1px solid #000; 
            margin: 5px 0;
            cursor: crosshair;
            background-color: white; 
            width: 140px;
        }
        
        .ttd-image {
            display: none; 
            width: 140px;
            height: 70px;
            margin: 5px 0;
            border: 1px solid #000; 
            object-fit: contain; 
        }

        .ttd-line {
            height: 55px; 
            width: 130px;
            border-bottom: 1px solid #000; 
            margin-bottom: 5px;
        }

        .ttd-label-top {
            font-size: 0.85em;
            margin-bottom: 5px;
            font-weight: normal;
        }

        .ttd-label-bottom {
            font-size: 0.8em;
            font-weight: bold;
            margin-top: 2px;
        }

        .actions {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        .actions button {
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #28a745; 
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .credit-text {
            text-align: right;
            margin-top: 20px;
            font-size: 0.7em;
            color: #999;
        }
        
        .hide-on-export { display: none !important; }
        
        .print-text {
            display: none;
            border-bottom: 1px solid #000;
            font-weight: bold;
        }

        @media print {
            .actions { display: none; }
        }
    </style>
</head>
<body>

    <div class="actions">
        <button onclick="sharePDF()">Bagikan Ke WhatsApp (PDF)</button>
    </div>

    <div class="container" id="pdf-content">
        <h1 class="title">BERITA ACARA SALES VARIANCE</h1>

        <div class="data-input">
            <label>KODE TOKO</label>
            <input type="text" id="kode_toko" maxlength="4" oninput="toUppercase(this)">
        </div>
        <div class="data-input">
            <label>NAMA PERSONIL</label>
            <input type="text" id="nama_personil" oninput="toUppercase(this)">
        </div>
        <div class="data-input">
            <label>NIK</label>
            <input type="text" id="nik" oninput="onlyNumbers(this)">
        </div>
        <div class="data-input">
            <label>JABATAN</label>
            <input type="text" id="jabatan" oninput="toUppercase(this)">
        </div>

        <div class="keterangan-section">
            <p>
                Menerangkan pengajuan potong sales Variance Plus senilai: 
                <strong>Rp. </strong><input type="text" id="nilai_sales" placeholder="..." onkeyup="formatAngka(this)" style="width: 150px;">
                <span id="nilai_sales_print" class="print-text"></span>
            </p>
            <p>
                Tanggal kejadian: 
                <input type="date" id="tanggal_kejadian"> 
                <span id="tanggal_kejadian_print" class="print-text"></span>
            </p>
            <p>Dengan kronologi sebagai berikut:</p>
            <textarea id="kronologi" placeholder="Tuliskan kronologi di sini..."></textarea>
            <div id="kronologi_print" class="print-text" style="white-space: pre-wrap; min-height: 80px; width: 100%; border: 1px solid #eee; display:none; padding: 10px;"></div>
        </div>

        <p style="margin-top: 15px; font-size: 0.9em;">Demikian berita acara ini saya buat dengan sebenar-benarnya. Terima kasih.</p>

        <div class="signature-main-grid">
            
            <div class="ttd-single-box">
                <span class="ttd-label-top">Sidoarjo, <span id="tgl_skrg"></span></span>
                <span class="ttd-label-top" style="font-weight: bold;">Pembuat,</span>
                <canvas id="sig-canvas" class="ttd-area"></canvas>
                <img id="sig-image" class="ttd-image">
                <div class="hide-on-export">
                    <button onclick="clearSig()" style="font-size: 9px; cursor:pointer;">Hapus TTD</button>
                </div>
                <span class="ttd-label-bottom">( <span id="display_nama">TIM TOKO</span> )</span>
            </div>

            <div class="sub-grid">
                <div class="ttd-single-box">
                    <span class="ttd-label-top">Diketahui,</span>
                    <div class="ttd-line"></div>
                    <span class="ttd-label-bottom">(Area Supervisor)</span>
                </div>
                <div class="ttd-single-box">
                    <span class="ttd-label-top">Diketahui,</span>
                    <div class="ttd-line"></div>
                    <span class="ttd-label-bottom">(Area Manager)</span>
                </div>
            </div>
            
            <div class="sub-grid">
                <div class="ttd-single-box">
                    <span class="ttd-label-top">Pemeriksa,</span>
                    <div class="ttd-line"></div>
                    <span class="ttd-label-bottom">(EDP Manager)</span>
                </div>
                <div class="ttd-single-box">
                    <span class="ttd-label-top">Pemeriksa,</span>
                    <div class="ttd-line"></div>
                    <span class="ttd-label-bottom">(Office Manager)</span>
                </div>
            </div>

            <div class="ttd-single-box">
                <span class="ttd-label-top">Menyetujui,</span>
                <div class="ttd-line" style="width: 160px;"></div>
                <span class="ttd-label-bottom">(DBM OPR / BM)</span>
            </div>

        </div>

        <div class="credit-text">Print File</div>
    </div>

    <script>
        function onlyNumbers(input) { input.value = input.value.replace(/[^0-9]/g, ''); }
        function toUppercase(input) { input.value = input.value.toUpperCase(); }
        function formatAngka(input) {
            let val = input.value.replace(/[^0-9]/g, '');
            input.value = val.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        
        const canvas = document.getElementById('sig-canvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        canvas.width = 140;
        canvas.height = 70;
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        canvas.addEventListener('mousedown', (e) => { drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
        canvas.addEventListener('mousemove', (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); });
        window.addEventListener('mouseup', () => drawing = false);
        canvas.addEventListener('touchstart', (e) => { drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); e.preventDefault(); });
        canvas.addEventListener('touchmove', (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); });

        function clearSig() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

        async function sharePDF() {
            const nameInput = document.getElementById('nama_personil').value;
            const kodeToko = document.getElementById('kode_toko').value || 'TOKO';

            
            document.getElementById('nilai_sales_print').innerText = document.getElementById('nilai_sales').value;
            document.getElementById('nilai_sales').style.display = 'none';
            document.getElementById('nilai_sales_print').style.display = 'inline';

            document.getElementById('kronologi_print').innerText = document.getElementById('kronologi').value;
            document.getElementById('kronologi').style.display = 'none';
            document.getElementById('kronologi_print').style.display = 'block';

            const tglVal = document.getElementById('tanggal_kejadian').value;
            document.getElementById('tanggal_kejadian_print').innerText = tglVal ? tglVal.split('-').reverse().join('-') : '-';
            document.getElementById('tanggal_kejadian').style.display = 'none';
            document.getElementById('tanggal_kejadian_print').style.display = 'inline';

            if(nameInput) document.getElementById('display_nama').innerText = nameInput;

            const sigImg = document.getElementById('sig-image');
            sigImg.src = canvas.toDataURL();
            sigImg.style.display = 'block';
            canvas.style.display = 'none';
            
            document.querySelectorAll('.hide-on-export').forEach(el => el.style.display = 'none');

            const element = document.getElementById('pdf-content');
            const filename = `BA_VAR_${kodeToko}.pdf`;

            const opt = {
                margin: [10, 5, 10, 5],
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 3, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            try {
                const pdfBlob = await html2pdf().set(opt).from(element).outputPdf('blob');
                const file = new File([pdfBlob], filename, { type: 'application/pdf' });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'Berita Acara Sales Variance',
                    });
                } else {
                    html2pdf().set(opt).from(element).save();
                }
            } catch (err) {
                alert("Proses PDF terganggu");
            } finally {
                setTimeout(() => { location.reload(); }, 1500); 
            }
        }

        const now = new Date();
        document.getElementById('tgl_skrg').innerText = `${now.getDate()}-${now.getMonth()+1}-${now.getFullYear()}`;
    </script>
</body>
</html>
